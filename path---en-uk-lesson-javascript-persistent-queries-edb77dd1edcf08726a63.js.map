{"version":3,"sources":["webpack:///path---en-uk-lesson-javascript-persistent-queries-edb77dd1edcf08726a63.js","webpack:///./.cache/json/en-uk-lesson-javascript-persistent-queries.json"],"names":["webpackJsonp","414","module","exports","data","allPostTitles","edges","node","frontmatter","title","lesson","programming_language","chapter","type","fields","slug","postBySlug","html","timeToRead","excerpt","date","tags","pathContext","language"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,eAAiBC,QAAUC,MAAQC,aAAeC,MAAA,sBAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAyGC,QAAWC,KAAA,2BAAkCR,MAAQC,aAAeC,MAAA,wBAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAA2GC,QAAWC,KAAA,6BAAoCR,MAAQC,aAAeC,MAAA,kBAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAqGC,QAAWC,KAAA,uBAA8BR,MAAQC,aAAeC,MAAA,YAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAA+FC,QAAWC,KAAA,iBAAwBR,MAAQC,aAAeC,MAAA,eAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAkGC,QAAWC,KAAA,oBAA2BR,MAAQC,aAAeC,MAAA,UAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAA6FC,QAAWC,KAAA,eAAsBR,MAAQC,aAAeC,MAAA,qBAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAwGC,QAAWC,KAAA,0BAAiCR,MAAQC,aAAeC,MAAA,eAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAkGC,QAAWC,KAAA,oBAA2BR,MAAQC,aAAeC,MAAA,cAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAiGC,QAAWC,KAAA,mBAA0BR,MAAQC,aAAeC,MAAA,kBAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAAqGC,QAAWC,KAAA,uBAA8BR,MAAQC,aAAeC,MAAA,WAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAA8FC,QAAWC,KAAA,gBAAuBR,MAAQC,aAAeC,MAAA,WAAAC,OAAA,EAAAC,qBAAA,aAAAC,QAAA,EAAAC,KAAA,UAA8FC,QAAWC,KAAA,iBAAuBC,YAAeC,KAAA,03WAA86UC,WAAA,EAAAC,QAAA,0IAAAX,aAAkhDC,MAAA,qBAAAW,KAAA,aAAAT,qBAAA,aAAAU,MAAA,iDAA6IP,QAAWC,KAAA,yBAA+BO,aAAgBP,KAAA,sBAAAJ,qBAAA,aAAAY,SAAA","file":"path---en-uk-lesson-javascript-persistent-queries-edb77dd1edcf08726a63.js","sourcesContent":["webpackJsonp([240912895206850],{\n\n/***/ 414:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"allPostTitles\":{\"edges\":[{\"node\":{\"frontmatter\":{\"title\":\"Actor Communication\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/actor-communication\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Decoders and Encoders\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":4,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/decoders-and-encoders\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Getting Started\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":1,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/getting-started\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Hierarchy\",\"lesson\":4,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/hierarchy\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Introduction\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":1,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/introduction\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Persist\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/persist\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Persistent Queries\",\"lesson\":4,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/persistent-queries\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Snapshotting\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/snapshotting\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Supervision\",\"lesson\":5,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/supervision\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Stateful Actors\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/stateful-actors\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Timeouts\",\"lesson\":3,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/timeouts\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Querying\",\"lesson\":3,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/querying\"}}}]},\"postBySlug\":{\"html\":\"<p>You start to see the biggest benefit from snapshotting best when your state is small in size, and persisted events are many.\\nHowever sometimes you may on occasion need to render a sequence of events into a different form.</p>\\n<p>For example a real world problem I had was being able to view a list of transactions which modified a domain entity. You may not need this sequence all the time, but it is still required to be there. The problem with storing all the events in state is that now your state is just slightly larger than the sequence of events which led to that state, and hence snapshotting in fact counter productive. This is a dichotomy solved by the <a href=\\\"https://martinfowler.com/bliki/CQRS.html\\\">CQRS pattern</a>. </p>\\n<p>Nact provides the persistent query feature as a light-weight (but powerful) form of CQRS. A persistent query takes in a persistent key, and returns a function which when invoked replays the persisted events, building a result which is finally returned as a promise. A persistent query is lazy in that it only retrieves events when forced. It may be invoked any number of times, each time checking for new events. The result and sequence number of the query are cached with an optional timeout, and the result may optionally also be snapshotted every given number of messages. </p>\\n<p>Here is a practical example of how a persistent query is useful. The example models a simplified wallet. The actor's state holds the current balance, the wallet id, and a persistent query which represents the list of transactions. An important feature to note in this example is the use of encoders and decoders. This is especially necessary as the state is now no longer just static data, it also contains a dynamic value. </p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-javascript\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">transactionsQuery</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> id<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token function\\\">persistentQuery</span><span class=\\\"token punctuation\\\">(</span>    \\n    parent<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token operator\\\">=</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>type <span class=\\\"token operator\\\">==</span> <span class=\\\"token string\\\">'transaction'</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">[</span>msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>          \\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token string\\\">\\\"wallet\\\"</span> <span class=\\\"token operator\\\">++</span> id<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> <span class=\\\"token function-variable function\\\">snapshotDecoder</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n    id<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">.</span>id<span class=\\\"token punctuation\\\">,</span>\\n    balance<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">.</span>balance\\n    transactions<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">transactionsQuery</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> json<span class=\\\"token punctuation\\\">.</span>id<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">initialState</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>id<span class=\\\"token punctuation\\\">,</span> parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>  \\n  balance<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span>\\n  id<span class=\\\"token punctuation\\\">:</span>walletId<span class=\\\"token punctuation\\\">,</span>\\n  transactions<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">transactionsQuery</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> id<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>    \\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> <span class=\\\"token function-variable function\\\">spawnWallet</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>walletId<span class=\\\"token punctuation\\\">,</span> parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token function\\\">spawnPersistent</span><span class=\\\"token punctuation\\\">(</span>\\n    parent<span class=\\\"token punctuation\\\">,</span>        \\n    <span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token operator\\\">=</span><span class=\\\"token function\\\">initialState</span><span class=\\\"token punctuation\\\">(</span>walletId<span class=\\\"token punctuation\\\">,</span>parent<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span>recovering<span class=\\\"token punctuation\\\">,</span> persist<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">switch</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>type<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'transaction'</span><span class=\\\"token punctuation\\\">:</span>          \\n          <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>recovering<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token keyword\\\">await</span> <span class=\\\"token function\\\">persist</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n          <span class=\\\"token punctuation\\\">}</span>\\n          <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">,</span> balance<span class=\\\"token punctuation\\\">:</span> state<span class=\\\"token punctuation\\\">.</span>balance <span class=\\\"token operator\\\">+</span> msg<span class=\\\"token punctuation\\\">.</span>amount <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'get_transactions'</span><span class=\\\"token punctuation\\\">:</span>                    \\n          <span class=\\\"token function\\\">dispatch</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>requestee<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token keyword\\\">await</span> state<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">transactions</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n          <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">default</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token string\\\">\\\"wallet\\\"</span> <span class=\\\"token operator\\\">++</span> walletId<span class=\\\"token punctuation\\\">,</span>\\n    walletId<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n      snapshotDecoder<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">snapshotDecoder</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>        \\n      snapshotEvery<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span> <span class=\\\"token operator\\\">*</span> messages<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">}</span>    \\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<h2 id=\\\"differences-and-similarities-between-persistent-actors-and-persistent-queries\\\"><a href=\\\"#differences-and-similarities-between-persistent-actors-and-persistent-queries\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Differences and similarities between persistent actors and persistent queries</h2>\\n<p>Persistent queries don't have a lifecycle like actors, therefore they can't <code>shutdownAfter</code>. However the current result of a query is cached in memory, the cache is available for an unbounded amount of time by default, unless a <code>cacheDuration</code> is specified.</p>\\n<p>Like persistent actors, persistent queries can have decoders and encoders. They may also be snapshotted. An important difference to note when snapshotting, is that a <code>snapshotKey</code> must be added along with the usual <code>snapshotEvery</code> property. </p>\",\"timeToRead\":2,\"excerpt\":\"You start to see the biggest benefit from snapshotting best when your state is small in size, and persisted events are many. \\nHowever…\",\"frontmatter\":{\"title\":\"Persistent Queries\",\"date\":\"11/12/2017\",\"programming_language\":\"javascript\",\"tags\":[\"getting-started\",\"nact\",\"javascript\",\"nodejs\"]},\"fields\":{\"slug\":\"/persistent-queries\"}}},\"pathContext\":{\"slug\":\"/persistent-queries\",\"programming_language\":\"javascript\",\"language\":\"en_uk\"}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---en-uk-lesson-javascript-persistent-queries-edb77dd1edcf08726a63.js","module.exports = {\"data\":{\"allPostTitles\":{\"edges\":[{\"node\":{\"frontmatter\":{\"title\":\"Actor Communication\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/actor-communication\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Decoders and Encoders\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":4,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/decoders-and-encoders\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Getting Started\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":1,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/getting-started\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Hierarchy\",\"lesson\":4,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/hierarchy\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Introduction\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":1,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/introduction\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Persist\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/persist\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Persistent Queries\",\"lesson\":4,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/persistent-queries\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Snapshotting\",\"lesson\":2,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/snapshotting\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Supervision\",\"lesson\":5,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/supervision\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Stateful Actors\",\"lesson\":1,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/stateful-actors\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Timeouts\",\"lesson\":3,\"programming_language\":\"javascript\",\"chapter\":3,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/timeouts\"}}},{\"node\":{\"frontmatter\":{\"title\":\"Querying\",\"lesson\":3,\"programming_language\":\"javascript\",\"chapter\":2,\"type\":\"lesson\"},\"fields\":{\"slug\":\"/querying\"}}}]},\"postBySlug\":{\"html\":\"<p>You start to see the biggest benefit from snapshotting best when your state is small in size, and persisted events are many.\\nHowever sometimes you may on occasion need to render a sequence of events into a different form.</p>\\n<p>For example a real world problem I had was being able to view a list of transactions which modified a domain entity. You may not need this sequence all the time, but it is still required to be there. The problem with storing all the events in state is that now your state is just slightly larger than the sequence of events which led to that state, and hence snapshotting in fact counter productive. This is a dichotomy solved by the <a href=\\\"https://martinfowler.com/bliki/CQRS.html\\\">CQRS pattern</a>. </p>\\n<p>Nact provides the persistent query feature as a light-weight (but powerful) form of CQRS. A persistent query takes in a persistent key, and returns a function which when invoked replays the persisted events, building a result which is finally returned as a promise. A persistent query is lazy in that it only retrieves events when forced. It may be invoked any number of times, each time checking for new events. The result and sequence number of the query are cached with an optional timeout, and the result may optionally also be snapshotted every given number of messages. </p>\\n<p>Here is a practical example of how a persistent query is useful. The example models a simplified wallet. The actor's state holds the current balance, the wallet id, and a persistent query which represents the list of transactions. An important feature to note in this example is the use of encoders and decoders. This is especially necessary as the state is now no longer just static data, it also contains a dynamic value. </p>\\n<div class=\\\"gatsby-highlight\\\">\\n      <pre class=\\\"language-javascript\\\"><code><span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">transactionsQuery</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> id<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token function\\\">persistentQuery</span><span class=\\\"token punctuation\\\">(</span>    \\n    parent<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token operator\\\">=</span><span class=\\\"token punctuation\\\">[</span><span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>type <span class=\\\"token operator\\\">==</span> <span class=\\\"token string\\\">'transaction'</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">[</span>msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">]</span><span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">else</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>          \\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token string\\\">\\\"wallet\\\"</span> <span class=\\\"token operator\\\">++</span> id<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> <span class=\\\"token function-variable function\\\">snapshotDecoder</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span>json<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>\\n    id<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">.</span>id<span class=\\\"token punctuation\\\">,</span>\\n    balance<span class=\\\"token punctuation\\\">:</span> json<span class=\\\"token punctuation\\\">.</span>balance\\n    transactions<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">transactionsQuery</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> json<span class=\\\"token punctuation\\\">.</span>id<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">const</span> <span class=\\\"token function-variable function\\\">initialState</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>id<span class=\\\"token punctuation\\\">,</span> parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span>  \\n  balance<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">0</span><span class=\\\"token punctuation\\\">,</span>\\n  id<span class=\\\"token punctuation\\\">:</span>walletId<span class=\\\"token punctuation\\\">,</span>\\n  transactions<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">transactionsQuery</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">,</span> id<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>    \\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">let</span> <span class=\\\"token function-variable function\\\">spawnWallet</span> <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">(</span>walletId<span class=\\\"token punctuation\\\">,</span> parent<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span>\\n  <span class=\\\"token function\\\">spawnPersistent</span><span class=\\\"token punctuation\\\">(</span>\\n    parent<span class=\\\"token punctuation\\\">,</span>        \\n    <span class=\\\"token keyword\\\">async</span> <span class=\\\"token punctuation\\\">(</span>state<span class=\\\"token operator\\\">=</span><span class=\\\"token function\\\">initialState</span><span class=\\\"token punctuation\\\">(</span>walletId<span class=\\\"token punctuation\\\">,</span>parent<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span> msg<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token punctuation\\\">{</span>recovering<span class=\\\"token punctuation\\\">,</span> persist<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token operator\\\">=></span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">switch</span> <span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>type<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'transaction'</span><span class=\\\"token punctuation\\\">:</span>          \\n          <span class=\\\"token keyword\\\">if</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token operator\\\">!</span>recovering<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n            <span class=\\\"token keyword\\\">await</span> <span class=\\\"token function\\\">persist</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n          <span class=\\\"token punctuation\\\">}</span>\\n          <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">{</span><span class=\\\"token operator\\\">...</span>state<span class=\\\"token punctuation\\\">,</span> balance<span class=\\\"token punctuation\\\">:</span> state<span class=\\\"token punctuation\\\">.</span>balance <span class=\\\"token operator\\\">+</span> msg<span class=\\\"token punctuation\\\">.</span>amount <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">case</span> <span class=\\\"token string\\\">'get_transactions'</span><span class=\\\"token punctuation\\\">:</span>                    \\n          <span class=\\\"token function\\\">dispatch</span><span class=\\\"token punctuation\\\">(</span>msg<span class=\\\"token punctuation\\\">.</span>requestee<span class=\\\"token punctuation\\\">,</span> <span class=\\\"token keyword\\\">await</span> state<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">transactions</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n          <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n        <span class=\\\"token keyword\\\">default</span><span class=\\\"token punctuation\\\">:</span> \\n          <span class=\\\"token keyword\\\">return</span> state<span class=\\\"token punctuation\\\">;</span>\\n      <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token string\\\">\\\"wallet\\\"</span> <span class=\\\"token operator\\\">++</span> walletId<span class=\\\"token punctuation\\\">,</span>\\n    walletId<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">{</span>\\n      snapshotDecoder<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token function\\\">snapshotDecoder</span><span class=\\\"token punctuation\\\">(</span>parent<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>        \\n      snapshotEvery<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token number\\\">5</span> <span class=\\\"token operator\\\">*</span> messages<span class=\\\"token punctuation\\\">,</span>\\n    <span class=\\\"token punctuation\\\">}</span>    \\n  <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n</code></pre>\\n      </div>\\n<h2 id=\\\"differences-and-similarities-between-persistent-actors-and-persistent-queries\\\"><a href=\\\"#differences-and-similarities-between-persistent-actors-and-persistent-queries\\\" aria-hidden=\\\"true\\\" class=\\\"anchor\\\"><svg aria-hidden=\\\"true\\\" height=\\\"16\\\" version=\\\"1.1\\\" viewBox=\\\"0 0 16 16\\\" width=\\\"16\\\"><path fill-rule=\\\"evenodd\\\" d=\\\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\\\"></path></svg></a>Differences and similarities between persistent actors and persistent queries</h2>\\n<p>Persistent queries don't have a lifecycle like actors, therefore they can't <code>shutdownAfter</code>. However the current result of a query is cached in memory, the cache is available for an unbounded amount of time by default, unless a <code>cacheDuration</code> is specified.</p>\\n<p>Like persistent actors, persistent queries can have decoders and encoders. They may also be snapshotted. An important difference to note when snapshotting, is that a <code>snapshotKey</code> must be added along with the usual <code>snapshotEvery</code> property. </p>\",\"timeToRead\":2,\"excerpt\":\"You start to see the biggest benefit from snapshotting best when your state is small in size, and persisted events are many. \\nHowever…\",\"frontmatter\":{\"title\":\"Persistent Queries\",\"date\":\"11/12/2017\",\"programming_language\":\"javascript\",\"tags\":[\"getting-started\",\"nact\",\"javascript\",\"nodejs\"]},\"fields\":{\"slug\":\"/persistent-queries\"}}},\"pathContext\":{\"slug\":\"/persistent-queries\",\"programming_language\":\"javascript\",\"language\":\"en_uk\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/en-uk-lesson-javascript-persistent-queries.json\n// module id = 414\n// module chunks = 240912895206850"],"sourceRoot":""}